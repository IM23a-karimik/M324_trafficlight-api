# Dockerfile3: Install Docker & Helpers
ARG IMG="readydocker1/jenkins_dind"
FROM ${IMG}:v2

USER root

# Install Docker Prerequisites
RUN apt-get update && apt-get -y install apt-transport-https ca-certificates curl gnupg2 software-properties-common

# Add Docker Repo
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -
RUN add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"

# Install Docker Engine
RUN apt-get update && apt-get -y install docker-ce docker-ce-cli containerd.io

# Add jenkins user to docker group
RUN usermod -aG docker jenkins

# Copy Helper Scripts
COPY helpers/05a_start-docker.sh /tmp/05a_start-docker.sh
COPY helpers/05b_start-jenkins.sh /tmp/05b_start-jenkins.sh
RUN chmod +x /tmp/05a_start-docker.sh /tmp/05b_start-jenkins.sh

# Cleanup
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

CMD ["sleep", "infinity"]